<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwissCV Pro ‚Äî Analyseur de CV</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --swiss-red: #D50000;
            --swiss-black: #0D0D0D;
            --swiss-white: #FFFFFF;
            --swiss-gray: #E6E6E6;
            --swiss-blue-light: #EEF3FF;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--swiss-white);
            color: var(--swiss-black);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .header {
            background: var(--swiss-white);
            border-bottom: 1px solid var(--swiss-gray);
            padding: 24px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }
        
        .logo-icon {
            font-size: 32px;
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .logo-text strong {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--swiss-black);
        }
        
        .logo-text span {
            font-size: 11px;
            font-weight: 400;
            color: #666;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .container {
            max-width: 900px;
            margin: 60px auto;
            padding: 0 40px;
        }
        
        .card {
            background: var(--swiss-white);
            border: 1px solid var(--swiss-gray);
            border-radius: 4px;
            padding: 60px;
            margin-bottom: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .upload-zone {
            border: 2px dashed var(--swiss-gray);
            border-radius: 4px;
            padding: 80px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #FAFAFA;
        }
        
        .upload-zone:hover {
            border-color: var(--swiss-red);
            background: var(--swiss-white);
        }
        
        .upload-zone.dragover {
            border-color: var(--swiss-red);
            background: var(--swiss-blue-light);
            transform: scale(1.01);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 24px;
            opacity: 0.7;
        }
        
        .upload-zone h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--swiss-black);
            margin-bottom: 8px;
            letter-spacing: -0.3px;
        }
        
        .upload-zone p {
            color: #666;
            font-size: 14px;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: var(--swiss-red);
            color: var(--swiss-white);
            border: none;
            padding: 16px 48px;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: -0.2px;
            display: inline-block;
        }
        
        .btn:hover:not(:disabled) {
            background: #B80000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(213, 0, 0, 0.25);
        }
        
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .selected-file {
            margin-top: 24px;
            padding: 20px;
            background: #F0F9FF;
            border: 1px solid #BAE6FF;
            border-radius: 4px;
            display: none;
            font-size: 14px;
        }
        
        .selected-file.show {
            display: block;
        }
        
        .selected-file strong {
            color: var(--swiss-black);
            font-weight: 600;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 80px 40px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner-ring {
            width: 64px;
            height: 64px;
            border: 3px solid var(--swiss-gray);
            border-top: 3px solid var(--swiss-red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 32px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--swiss-black);
            margin-bottom: 8px;
            letter-spacing: -0.3px;
        }
        
        .loading p {
            color: #666;
            font-size: 14px;
        }
        
        .results {
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .score-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 60px 0;
            margin-bottom: 60px;
            background: linear-gradient(180deg, #FAFAFA 0%, var(--swiss-white) 100%);
            border-radius: 4px;
        }
        
        .circular-score {
            position: relative;
            width: 200px;
            height: 200px;
            margin-bottom: 32px;
        }
        
        .circular-score svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        
        .score-ring {
            fill: none;
            stroke: var(--swiss-gray);
            stroke-width: 8;
        }
        
        .score-fill {
            fill: none;
            stroke: var(--swiss-red);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 565.48;
            stroke-dashoffset: 565.48;
            transition: stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .score-number {
            font-size: 56px;
            font-weight: 700;
            letter-spacing: -2px;
            color: var(--swiss-black);
        }
        
        .score-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }
        
        .score-comment {
            max-width: 600px;
            text-align: center;
            font-size: 16px;
            color: #666;
            line-height: 1.6;
            padding: 0 20px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--swiss-black);
            margin-bottom: 24px;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-icon {
            font-size: 24px;
        }
        
        .advice-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .advice-item {
            padding: 20px 24px;
            border-radius: 4px;
            border-left: 4px solid;
            font-size: 15px;
            line-height: 1.6;
        }
        
        .advice-item.positive {
            background: #F0FDF4;
            border-color: #16A34A;
            color: #15803D;
        }
        
        .advice-item.warning {
            background: #FFF7ED;
            border-color: #EA580C;
            color: #C2410C;
        }
        
        .advice-item.info {
            background: #EFF6FF;
            border-color: #2563EB;
            color: #1E40AF;
        }
        
        .actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 60px;
            padding-top: 60px;
            border-top: 1px solid var(--swiss-gray);
        }
        
        .btn-secondary {
            background: var(--swiss-white);
            color: var(--swiss-black);
            border: 2px solid var(--swiss-gray);
        }
        
        .btn-secondary:hover {
            background: #FAFAFA;
            border-color: var(--swiss-black);
        }
        
        .error-msg {
            background: #FEF2F2;
            color: #991B1B;
            padding: 16px 24px;
            border-radius: 4px;
            border-left: 4px solid #DC2626;
            margin-top: 24px;
            display: none;
            font-size: 14px;
        }
        
        .error-msg.show {
            display: block;
        }
        
        /* Photo check */
        .photo-check {
            margin-top: 24px;
            padding: 20px;
            background: #FFF7ED;
            border: 1px solid #FED7AA;
            border-radius: 4px;
            display: none;
        }
        
        .photo-check.show {
            display: block;
        }
        
        .photo-check label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 15px;
            color: var(--swiss-black);
        }
        
        .photo-check input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* Usage counter */
        .usage-counter {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #F0F9FF;
            border: 1px solid #BAE6FF;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .usage-counter span {
            color: #0284C7;
            font-weight: 700;
        }
        
        /* Modal upgrade */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            padding: 48px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }
        
        .modal-content h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--swiss-black);
            margin-bottom: 16px;
            letter-spacing: -0.5px;
        }
        
        .modal-content p {
            font-size: 16px;
            color: #666;
            margin-bottom: 32px;
            line-height: 1.6;
        }
        
        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .modal-btn {
            padding: 16px 32px;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
            display: inline-block;
        }
        
        .modal-btn-primary {
            background: var(--swiss-red);
            color: white;
        }
        
        .modal-btn-primary:hover {
            background: #B80000;
            transform: translateY(-1px);
        }
        
        .modal-btn-secondary {
            background: transparent;
            color: #666;
            border: 2px solid var(--swiss-gray);
        }
        
        .modal-btn-secondary:hover {
            background: #FAFAFA;
            color: var(--swiss-black);
        }
        
        .premium-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: var(--swiss-black);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        @media print {
            .header, .actions, .btn, .usage-counter {
                display: none;
            }
            
            .card {
                border: none;
                box-shadow: none;
                padding: 20px;
            }
            
            body {
                background: white;
            }
        }
        
        /* ============================================================ */
        /* üé® STYLES MODULE LETTRE DE MOTIVATION                       */
        /* ============================================================ */
        
        /* Premium Badge inline */
        .premium-badge-inline {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: var(--swiss-black);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .premium-feature-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 32px;
            border-bottom: 1px solid var(--swiss-gray);
        }

        /* Formulaire */
        .form-group {
            margin-bottom: 28px;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            font-weight: 600;
            color: var(--swiss-black);
            margin-bottom: 12px;
        }

        .form-label-icon {
            font-size: 18px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--swiss-gray);
            border-radius: 4px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            background: white;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--swiss-red);
            box-shadow: 0 0 0 3px rgba(213, 0, 0, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Radio buttons */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            border: 2px solid var(--swiss-gray);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radio-option:hover {
            border-color: var(--swiss-red);
            background: #FFF5F5;
        }

        .radio-option input[type="radio"] {
            margin-top: 2px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-option input[type="radio"]:checked {
            accent-color: var(--swiss-red);
        }

        .radio-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .radio-label strong {
            font-size: 15px;
            color: var(--swiss-black);
        }

        .radio-label small {
            font-size: 13px;
            color: #666;
        }

        /* Aper√ßu lettre */
        .letter-preview {
            background: white;
            border: 1px solid var(--swiss-gray);
            border-radius: 4px;
            padding: 60px;
            font-family: 'Georgia', serif;
            line-height: 1.8;
            color: var(--swiss-black);
        }

        .letter-header {
            margin-bottom: 40px;
        }

        .letter-header > div {
            margin-bottom: 16px;
        }

        .letter-body {
            margin: 32px 0;
            white-space: pre-wrap;
        }

        .letter-body:focus {
            outline: 2px solid var(--swiss-red);
            outline-offset: 4px;
            border-radius: 4px;
        }

        .letter-signature {
            margin-top: 40px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 20px;
                margin: 40px auto;
            }
            
            .card {
                padding: 32px 24px;
            }
            
            .header-content {
                padding: 0 20px;
            }
            
            .logo-text strong {
                font-size: 18px;
            }
            
            .modal-content {
                padding: 32px 24px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .letter-preview {
                padding: 32px 20px;
            }
            
            .radio-group {
                gap: 8px;
            }
        }
        
        /* ============================================================ */
        /* üéØ STYLES MODULE ATS (T√ÇCHE #2)                             */
        /* ============================================================ */
        
        .ats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--swiss-gray);
        }
        
        .ats-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--swiss-black);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .ats-score-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #D50000 0%, #B80000 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(213, 0, 0, 0.3);
        }
        
        .ats-gauge-container {
            background: #FAFAFA;
            padding: 24px;
            border-radius: 4px;
            margin-bottom: 32px;
        }
        
        .ats-gauge-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--swiss-black);
            margin-bottom: 12px;
            text-align: center;
        }
        
        .ats-gauge-bar {
            width: 100%;
            height: 24px;
            background: var(--swiss-gray);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 8px;
        }
        
        .ats-gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, #D50000 0%, #FF4444 100%);
            border-radius: 12px;
            transition: width 1s ease-out;
            position: relative;
        }
        
        .ats-gauge-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            animation: shine 2s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .ats-gauge-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        
        .ats-score-interpretation {
            text-align: center;
            margin-top: 12px;
            font-size: 14px;
            color: #666;
        }
        
        .sector-detection {
            background: #F0F0F0;
            padding: 16px 20px;
            border-radius: 6px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sector-icon {
            font-size: 24px;
        }
        
        .sector-text {
            flex: 1;
        }
        
        .sector-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .sector-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--swiss-red);
            margin-top: 4px;
        }
        
        .keywords-container {
            margin-bottom: 32px;
        }
        
        .keywords-subtitle {
            font-size: 18px;
            font-weight: 700;
            color: var(--swiss-black);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .keywords-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 1px solid var(--swiss-gray);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .keywords-table thead {
            background: #FAFAFA;
        }
        
        .keywords-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--swiss-gray);
        }
        
        .keywords-table tbody tr {
            border-bottom: 1px solid #F0F0F0;
            transition: background 0.2s;
        }
        
        .keywords-table tbody tr:hover {
            background: #FAFAFA;
        }
        
        .keywords-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .keywords-table td {
            padding: 14px 16px;
            font-size: 14px;
            color: #333;
        }
        
        .importance-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .importance-high {
            background: #FFE6E6;
            color: #D50000;
            border: 2px solid #D50000;
        }
        
        .importance-medium {
            background: #FFF4E6;
            color: #FF8800;
            border: 2px solid #FF8800;
        }
        
        .importance-low {
            background: #F0F0F0;
            color: #999;
            border: 2px solid #CCCCCC;
        }
        
        .keyword-text {
            font-weight: 600;
            color: var(--swiss-black);
        }
        
        .keyword-detected {
            color: #00AA00;
            font-weight: 700;
        }
        
        .keyword-missing {
            color: #D50000;
            font-weight: 700;
        }
        
        .sector-advice-container {
            background: linear-gradient(135deg, #FFF4E6 0%, #FFE6E6 100%);
            padding: 24px;
            border-radius: 8px;
            border-left: 4px solid var(--swiss-red);
        }
        
        .advice-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--swiss-black);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .advice-list-ats {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .advice-list-ats li {
            padding: 12px 0;
            font-size: 15px;
            color: #333;
            line-height: 1.6;
            display: flex;
            gap: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .advice-list-ats li:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .advice-list-ats li::before {
            content: "üí°";
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .ats-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 16px;
        }
        
        /* ============================================================ */
        /* üñ®Ô∏è STYLES D'IMPRESSION (si besoin de Ctrl+P direct)        */
        /* ============================================================ */
        
        @media print {
            .header, .actions, .btn, .usage-counter, .modal-overlay, #coverLetterSection {
                display: none !important;
            }
            
            .card {
                border: none;
                box-shadow: none;
                padding: 20px;
            }
            
            body {
                background: white;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo" style="cursor: default;">
                <span class="logo-icon">üá®üá≠</span>
                <div class="logo-text">
                    <strong>SwissCV Pro</strong>
                    <span>Expert CV Suisse</span>
                </div>
            </a>
            <div class="usage-counter">
                <span id="analysisCount">0</span> / 3 analyses gratuites
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div id="uploadSection">
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">üìÑ</div>
                    <h3>Glissez votre CV ici</h3>
                    <p>ou cliquez pour s√©lectionner (PDF ou DOCX, max 5MB)</p>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".pdf,.docx">
                
                <div id="selectedFile" class="selected-file">
                    <strong>‚úì Fichier s√©lectionn√© :</strong> <span id="fileName"></span>
                </div>
                
                <div id="photoCheck" class="photo-check">
                    <label>
                        <input type="checkbox" id="hasPhoto">
                        <span><strong>Mon CV contient une photo professionnelle</strong> (important pour le scoring suisse)</span>
                    </label>
                </div>
                
                <div style="text-align: center; margin-top: 32px;">
                    <button id="analyzeBtn" class="btn" disabled>Analyser mon CV gratuitement</button>
                </div>
                
                <div id="errorMsg" class="error-msg"></div>
            </div>
            
            <div id="loading" class="loading">
                <div class="spinner-ring"></div>
                <h3>Analyse en cours...</h3>
                <p>Notre IA √©value votre CV selon les standards suisses</p>
            </div>
            
            <div id="results" class="results">
                <div class="score-container">
                    <div class="circular-score">
                        <svg viewBox="0 0 200 200">
                            <circle class="score-ring" cx="100" cy="100" r="90"></circle>
                            <circle id="scoreCircle" class="score-fill" cx="100" cy="100" r="90"></circle>
                        </svg>
                        <div class="score-text">
                            <div id="scoreNumber" class="score-number">0</div>
                            <div class="score-label">Score</div>
                        </div>
                    </div>
                    <p id="scoreComment" class="score-comment"></p>
                </div>
                
                <div style="margin-bottom: 48px;">
                    <h2 class="section-title">
                        <span class="section-icon">‚úÖ</span>
                        Points forts
                    </h2>
                    <ul id="strongPoints" class="advice-list"></ul>
                </div>
                
                <div style="margin-bottom: 48px;">
                    <h2 class="section-title">
                        <span class="section-icon">‚ö†Ô∏è</span>
                        Am√©liorations recommand√©es
                    </h2>
                    <ul id="improvements" class="advice-list"></ul>
                </div>
                
                <div>
                    <h2 class="section-title">
                        <span class="section-icon">üá®üá≠</span>
                        Conseils sp√©cifiques Suisse romande
                    </h2>
                    <ul id="swissAdvice" class="advice-list"></ul>
                </div>
                
                <div class="actions">
                    <button id="resetBtn" class="btn btn-secondary">üîÑ Analyser un autre CV</button>
                    <button id="exportPdfBtn" class="btn">üì• Exporter en PDF</button>
                </div>
                
                <div style="text-align: center; margin-top: 24px; font-size: 12px; color: #999;">
                    <p>Analyse g√©n√©r√©e le <span id="printDate"></span> par SwissCV Pro</p>
                </div>
            </div>
        </div>

        <!-- ================================================================ -->
        <!-- üéØ MODULE ANALYSE ATS (T√ÇCHE #2)                               -->
        <!-- ================================================================ -->
        
        <!-- Section ATS compl√®te (masqu√©e par d√©faut) -->
        <div id="atsSection" class="card" style="display: none; margin-top: 40px;">
            <!-- En-t√™te avec score -->
            <div class="ats-header">
                <h2 class="ats-title">
                    üéØ Analyse ATS (Applicant Tracking System)
                </h2>
                <div class="ats-score-badge">
                    <span>Score:</span>
                    <span id="atsScoreValue">--</span>
                    <span>/100</span>
                </div>
            </div>
            
            <!-- Jauge de score -->
            <div class="ats-gauge-container">
                <div class="ats-gauge-title">Compatibilit√© avec les syst√®mes de recrutement automatis√©s</div>
                <div class="ats-gauge-bar">
                    <div id="atsGaugeFill" class="ats-gauge-fill" style="width: 0%;"></div>
                </div>
                <div class="ats-gauge-labels">
                    <span>0%</span>
                    <span>25%</span>
                    <span>50%</span>
                    <span>75%</span>
                    <span>100%</span>
                </div>
                <div id="atsScoreInterpretation" class="ats-score-interpretation"></div>
            </div>
            
            <!-- D√©tection secteur -->
            <div id="sectorDetection" class="sector-detection">
                <div class="sector-icon">üè¢</div>
                <div class="sector-text">
                    <div class="sector-label">Secteur d√©tect√©</div>
                    <div id="sectorName" class="sector-name">--</div>
                </div>
            </div>
            
            <!-- Mots-cl√©s d√©tect√©s -->
            <div class="keywords-container">
                <h3 class="keywords-subtitle">‚úÖ Mots-cl√©s pr√©sents dans votre CV</h3>
                <div id="detectedKeywordsContainer"></div>
            </div>
            
            <!-- Mots-cl√©s manquants -->
            <div class="keywords-container">
                <h3 class="keywords-subtitle">‚ö†Ô∏è Mots-cl√©s recommand√©s √† ajouter</h3>
                <table class="keywords-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Mot-cl√©</th>
                            <th style="width: 25%;">Importance</th>
                            <th style="width: 35%;">Statut</th>
                        </tr>
                    </thead>
                    <tbody id="missingKeywordsBody">
                        <!-- Rempli dynamiquement -->
                    </tbody>
                </table>
            </div>
            
            <!-- Conseils sectoriels -->
            <div id="sectorAdviceContainer" class="sector-advice-container">
                <h3 class="advice-title">
                    üíº Conseils sp√©cifiques pour le march√© suisse
                </h3>
                <ul id="adviceList" class="advice-list-ats">
                    <!-- Rempli dynamiquement -->
                </ul>
            </div>
        </div>

        <!-- √âtat de chargement ATS -->
        <div id="atsLoadingState" class="card ats-loading" style="display: none; margin-top: 40px;">
            <div class="spinner-ring" style="margin: 0 auto 32px;"></div>
            <p style="text-align: center; font-weight: 500;">Analyse ATS en cours...</p>
            <p style="text-align: center; font-size: 13px; color: #999;">Extraction des mots-cl√©s et d√©tection du secteur</p>
        </div>
        
    </div>

    <!-- ================================================================ -->
    <!-- üìù MODULE G√âN√âRATION LETTRE DE MOTIVATION (Premium Feature)     -->
    <!-- ================================================================ -->
    <div class="container" id="coverLetterSection" style="display: none;">
        <div class="card">
            <div class="premium-feature-header">
                <span class="premium-badge-inline">‚≠ê PREMIUM</span>
                <h2 style="font-size: 28px; font-weight: 700; margin: 16px 0 8px 0;">
                    ‚úâÔ∏è G√©n√©ration de Lettre de Motivation
                </h2>
                <p style="color: #666; font-size: 15px; margin-bottom: 32px;">
                    Cr√©ez une lettre de motivation professionnelle, adapt√©e au march√© suisse romand
                </p>
            </div>

            <!-- Formulaire -->
            <div id="coverLetterForm">
                <!-- Type de lettre -->
                <div class="form-group">
                    <label class="form-label">
                        <span class="form-label-icon">üìã</span>
                        Type de lettre
                    </label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="letterType" value="response" checked>
                            <span class="radio-label">
                                <strong>R√©ponse √† une offre</strong>
                                <small>Vous r√©pondez √† une annonce sp√©cifique</small>
                            </span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="letterType" value="spontaneous">
                            <span class="radio-label">
                                <strong>Candidature spontan√©e</strong>
                                <small>Vous proposez vos services sans offre pr√©cise</small>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Entreprise -->
                <div class="form-group">
                    <label for="companyName" class="form-label">
                        <span class="form-label-icon">üè¢</span>
                        Nom de l'entreprise *
                    </label>
                    <input 
                        type="text" 
                        id="companyName" 
                        class="form-input"
                        placeholder="Ex: Nestl√© SA, Credit Suisse, Rolex..."
                        required
                    >
                </div>

                <!-- Poste vis√© -->
                <div class="form-group">
                    <label for="targetPosition" class="form-label">
                        <span class="form-label-icon">üíº</span>
                        Poste vis√© *
                    </label>
                    <input 
                        type="text" 
                        id="targetPosition" 
                        class="form-input"
                        placeholder="Ex: Manager Retail, D√©veloppeur Full-Stack, Chef de projet..."
                        required
                    >
                </div>

                <!-- Secteur d'activit√© -->
                <div class="form-group">
                    <label for="industry" class="form-label">
                        <span class="form-label-icon">üè≠</span>
                        Secteur d'activit√©
                    </label>
                    <select id="industry" class="form-select">
                        <option value="">S√©lectionnez un secteur</option>
                        <option value="banque-finance">Banque & Finance</option>
                        <option value="horlogerie-luxe">Horlogerie & Luxe</option>
                        <option value="pharma-sante">Pharma & Sant√©</option>
                        <option value="it-tech">IT & Technologies</option>
                        <option value="retail-commerce">Retail & Commerce</option>
                        <option value="industrie-ingenierie">Industrie & Ing√©nierie</option>
                        <option value="hotellerie-restauration">H√¥tellerie & Restauration</option>
                        <option value="education-formation">√âducation & Formation</option>
                        <option value="administration-publique">Administration Publique</option>
                        <option value="conseil-audit">Conseil & Audit</option>
                        <option value="communication-marketing">Communication & Marketing</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>

                <!-- Offre d'emploi -->
                <div class="form-group" id="jobOfferGroup">
                    <label for="jobOffer" class="form-label">
                        <span class="form-label-icon">üìÑ</span>
                        Description de l'offre (optionnel)
                    </label>
                    <textarea 
                        id="jobOffer" 
                        class="form-textarea"
                        rows="4"
                        placeholder="Copiez-collez l'annonce ou d√©crivez les principales responsabilit√©s..."
                    ></textarea>
                    <small style="color: #666; font-size: 13px; display: block; margin-top: 8px;">
                        Plus vous donnez d'informations, plus la lettre sera personnalis√©e
                    </small>
                </div>

                <!-- Motivations personnelles -->
                <div class="form-group">
                    <label for="motivation" class="form-label">
                        <span class="form-label-icon">üí°</span>
                        Vos motivations (optionnel)
                    </label>
                    <textarea 
                        id="motivation" 
                        class="form-textarea"
                        rows="3"
                        placeholder="Pourquoi ce poste ? Qu'est-ce qui vous attire dans cette entreprise ?"
                    ></textarea>
                </div>

                <!-- Messages d'erreur/succ√®s -->
                <div id="coverLetterError" class="error-msg"></div>

                <!-- Boutons d'action -->
                <div style="display: flex; gap: 16px; margin-top: 32px;">
                    <button id="generateLetterBtn" class="btn" style="flex: 1;">
                        ‚ú® G√©n√©rer la lettre de motivation
                    </button>
                    <button id="closeCoverLetterBtn" class="btn btn-secondary">
                        Annuler
                    </button>
                </div>
            </div>

            <!-- R√©sultat de la lettre -->
            <div id="coverLetterResult" style="display: none;">
                <div style="background: #F0FDF4; border: 2px solid #16A34A; border-radius: 4px; padding: 24px; margin-bottom: 32px;">
                    <h3 style="color: #15803D; margin-bottom: 8px; font-size: 18px;">
                        ‚úÖ Lettre g√©n√©r√©e avec succ√®s !
                    </h3>
                    <p style="color: #166534; font-size: 14px;">
                        Votre lettre de motivation est pr√™te. Vous pouvez la modifier directement ci-dessous avant de l'exporter.
                    </p>
                </div>

                <!-- Aper√ßu lettre -->
                <div class="letter-preview">
                    <div class="letter-header">
                        <div id="letterSender"></div>
                        <div id="letterRecipient"></div>
                        <div id="letterDate"></div>
                        <div id="letterObject"></div>
                    </div>
                    <div id="letterBody" class="letter-body" contenteditable="true"></div>
                    <div id="letterSignature" class="letter-signature"></div>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 16px; margin-top: 32px;">
                    <button id="exportLetterPdfBtn" class="btn" style="flex: 1;">
                        üì• Exporter en PDF
                    </button>
                    <button id="copyLetterBtn" class="btn btn-secondary">
                        üìã Copier le texte
                    </button>
                    <button id="newLetterBtn" class="btn btn-secondary">
                        üîÑ Nouvelle lettre
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Upgrade -->
    <div id="upgradeModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon">üîí</div>
            <h2>Limite atteinte</h2>
            <p>Vous avez utilis√© vos <strong>3 analyses gratuites</strong> ce mois-ci. Passez √† Premium pour des analyses illimit√©es et d√©bloquez toutes les fonctionnalit√©s.</p>
            
            <div class="modal-actions">
                <a href="pricing.html" class="modal-btn modal-btn-primary">
                    ‚ú® Passer √† Premium (9 CHF)
                </a>
                <button onclick="closeUpgradeModal()" class="modal-btn modal-btn-secondary">
                    Peut-√™tre plus tard
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>
        // ‚úÖ URL de votre worker Cloudflare
        const API_ENDPOINT = 'https://swisscv-api.dallyhermann-71e.workers.dev';
        
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const selectedFileDiv = document.getElementById('selectedFile');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const uploadSection = document.getElementById('uploadSection');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const errorMsg = document.getElementById('errorMsg');
        const resetBtn = document.getElementById('resetBtn');
        
        let selectedFile = null;
        
        uploadZone.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            handleFileSelect(file);
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            handleFileSelect(file);
        });
        
        function handleFileSelect(file) {
            if (!file) return;
            
            const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            const maxSize = 5 * 1024 * 1024;
            
            if (!validTypes.includes(file.type)) {
                showError('Format non support√©. Utilisez PDF ou DOCX.');
                return;
            }
            
            if (file.size > maxSize) {
                showError('Fichier trop volumineux (max 5MB).');
                return;
            }
            
            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
            selectedFileDiv.classList.add('show');
            document.getElementById('photoCheck').style.display = 'block';
            analyzeBtn.disabled = false;
            errorMsg.classList.remove('show');
        }
        
        async function extractTextFromPDF(file) {
            if (file.type === 'application/pdf') {
                return await extractPDFText(file);
            } else {
                return await extractDOCXText(file);
            }
        }
        
        async function extractPDFText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }
            
            return fullText;
        }
        
        async function extractDOCXText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }
        
        async function analyzeCVWithBackend(cvText, hasPhoto) {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    cvText,
                    hasPhoto 
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Erreur serveur');
            }
            
            return await response.json();
        }
        
        function displayResults(analysis) {
            loading.classList.remove('show');
            results.classList.add('show');
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('fr-CH', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('printDate').textContent = dateStr;
            
            const scoreCircle = document.getElementById('scoreCircle');
            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (analysis.score / 100) * circumference;
            
            setTimeout(() => {
                scoreCircle.style.strokeDashoffset = offset;
            }, 100);
            
            animateNumber(0, analysis.score, 2000);
            
            document.getElementById('scoreComment').textContent = analysis.scoreComment;
            
            const strongPointsList = document.getElementById('strongPoints');
            strongPointsList.innerHTML = '';
            analysis.strongPoints.forEach(point => {
                const li = document.createElement('li');
                li.className = 'advice-item positive';
                li.textContent = point;
                strongPointsList.appendChild(li);
            });
            
            const improvementsList = document.getElementById('improvements');
            improvementsList.innerHTML = '';
            analysis.improvements.forEach(point => {
                const li = document.createElement('li');
                li.className = 'advice-item warning';
                li.textContent = point;
                improvementsList.appendChild(li);
            });
            
            const swissAdviceList = document.getElementById('swissAdvice');
            swissAdviceList.innerHTML = '';
            analysis.swissAdvice.forEach(point => {
                const li = document.createElement('li');
                li.className = 'advice-item info';
                li.textContent = point;
                swissAdviceList.appendChild(li);
            });
            
            // ‚úÖ Ajouter le bouton lettre de motivation pour Premium
            addCoverLetterButton();
        }
        
        function animateNumber(start, end, duration) {
            const scoreNumberEl = document.getElementById('scoreNumber');
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (end - start) * eased);
                
                scoreNumberEl.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }
        
        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.classList.add('show');
        }
        
        resetBtn.addEventListener('click', () => {
            results.classList.remove('show');
            uploadSection.style.display = 'block';
            selectedFile = null;
            fileInput.value = '';
            selectedFileDiv.classList.remove('show');
            document.getElementById('photoCheck').style.display = 'none';
            document.getElementById('hasPhoto').checked = false;
            analyzeBtn.disabled = true;
            errorMsg.classList.remove('show');
            
            // ‚úÖ T√ÇCHE #2 : Masquer les sections ATS lors du reset
            hideATSSection();
            
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDashoffset = 565.48;
            document.getElementById('scoreNumber').textContent = '0';
        });
        
        document.getElementById('exportPdfBtn').addEventListener('click', () => {
            // ‚úÖ Cr√©er une nouvelle fen√™tre avec SEULEMENT le rapport CV
            const printWindow = window.open('', '_blank');
            
            // R√©cup√©rer le contenu du CV
            const resultsContent = document.getElementById('results').cloneNode(true);
            
            // Retirer les boutons d'action du clone
            const actionsDiv = resultsContent.querySelector('.actions');
            if (actionsDiv) actionsDiv.remove();
            
            // Cr√©er le HTML de la fen√™tre d'impression
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <title>Analyse CV - SwissCV Pro</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            font-family: 'Inter', -apple-system, sans-serif;
                            background: white;
                            color: #0D0D0D;
                            padding: 40px;
                            line-height: 1.6;
                        }
                        .score-container {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            padding: 60px 0;
                            margin-bottom: 60px;
                            background: linear-gradient(180deg, #FAFAFA 0%, white 100%);
                            border-radius: 4px;
                        }
                        .circular-score {
                            position: relative;
                            width: 200px;
                            height: 200px;
                            margin-bottom: 32px;
                        }
                        .circular-score svg {
                            transform: rotate(-90deg);
                            width: 100%;
                            height: 100%;
                        }
                        .score-ring {
                            fill: none;
                            stroke: #E6E6E6;
                            stroke-width: 8;
                        }
                        .score-fill {
                            fill: none;
                            stroke: #D50000;
                            stroke-width: 8;
                            stroke-linecap: round;
                        }
                        .score-text {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            text-align: center;
                        }
                        .score-number {
                            font-size: 56px;
                            font-weight: 700;
                            letter-spacing: -2px;
                            color: #0D0D0D;
                        }
                        .score-label {
                            font-size: 13px;
                            color: #666;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            font-weight: 500;
                        }
                        .score-comment {
                            max-width: 600px;
                            text-align: center;
                            font-size: 16px;
                            color: #666;
                            line-height: 1.6;
                            padding: 0 20px;
                        }
                        .section-title {
                            font-size: 20px;
                            font-weight: 700;
                            color: #0D0D0D;
                            margin-bottom: 24px;
                            letter-spacing: -0.5px;
                            display: flex;
                            align-items: center;
                            gap: 12px;
                        }
                        .section-icon {
                            font-size: 24px;
                        }
                        .advice-list {
                            list-style: none;
                            display: flex;
                            flex-direction: column;
                            gap: 16px;
                            margin-bottom: 48px;
                        }
                        .advice-item {
                            padding: 20px 24px;
                            border-radius: 4px;
                            border-left: 4px solid;
                            font-size: 15px;
                            line-height: 1.6;
                        }
                        .advice-item.positive {
                            background: #F0FDF4;
                            border-color: #16A34A;
                            color: #15803D;
                        }
                        .advice-item.warning {
                            background: #FFF7ED;
                            border-color: #EA580C;
                            color: #C2410C;
                        }
                        .advice-item.info {
                            background: #EFF6FF;
                            border-color: #2563EB;
                            color: #1E40AF;
                        }
                        .footer {
                            text-align: center;
                            margin-top: 60px;
                            padding-top: 24px;
                            border-top: 1px solid #E6E6E6;
                            font-size: 12px;
                            color: #999;
                        }
                        @media print {
                            body {
                                padding: 20px;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${resultsContent.innerHTML}
                    <div class="footer">
                        <p>Analyse g√©n√©r√©e le ${new Date().toLocaleDateString('fr-CH', { year: 'numeric', month: 'long', day: 'numeric' })} par SwissCV Pro</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            // Attendre un court instant que le contenu soit rendu puis imprimer
            setTimeout(() => {
                printWindow.print();
            }, 250);
        });
        
        // ==================== FREEMIUM SYSTEM (CORRECTED) ====================
        const FREE_ANALYSIS_LIMIT = 3;
        
        // ‚úÖ CORRECTION 2 : Fonction pour v√©rifier si l'utilisateur est Premium
        function isPremiumUser() {
            const premiumStatus = localStorage.getItem('swisscv_premium');
            return premiumStatus === 'true';
        }
        
        function getAnalysisCount() {
            // Si Premium, pas de limite
            if (isPremiumUser()) {
                return 0;
            }
            
            const count = localStorage.getItem('swisscv_analysis_count');
            const month = localStorage.getItem('swisscv_analysis_month');
            const currentMonth = new Date().getMonth();
            
            // Reset counter si nouveau mois
            if (month !== currentMonth.toString()) {
                localStorage.setItem('swisscv_analysis_count', '0');
                localStorage.setItem('swisscv_analysis_month', currentMonth.toString());
                return 0;
            }
            
            return parseInt(count) || 0;
        }
        
        function incrementAnalysisCount() {
            // Si Premium, ne pas incr√©menter
            if (isPremiumUser()) {
                return 0;
            }
            
            const currentCount = getAnalysisCount();
            const newCount = currentCount + 1;
            localStorage.setItem('swisscv_analysis_count', newCount.toString());
            updateCounterDisplay();
            return newCount;
        }
        
        function updateCounterDisplay() {
            // ‚úÖ CORRECTION 2 : Afficher "Illimit√©" si Premium
            if (isPremiumUser()) {
                document.querySelector('.usage-counter').innerHTML = '<span class="premium-badge">‚≠ê PREMIUM</span> Analyses illimit√©es';
                return;
            }
            
            const count = getAnalysisCount();
            document.getElementById('analysisCount').textContent = count;
            
            // Changer couleur si limite proche
            const counterEl = document.getElementById('analysisCount');
            if (count >= FREE_ANALYSIS_LIMIT) {
                counterEl.style.color = '#E65100';
            } else if (count === FREE_ANALYSIS_LIMIT - 1) {
                counterEl.style.color = '#FF9800';
            }
        }
        
        function canAnalyze() {
            // ‚úÖ CORRECTION 2 : Si Premium, toujours autoriser
            if (isPremiumUser()) {
                return true;
            }
            return getAnalysisCount() < FREE_ANALYSIS_LIMIT;
        }
        
        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('show');
            
            // Track event
            if (typeof gtag !== 'undefined') {
                gtag('event', 'limit_reached', {
                    'event_category': 'freemium'
                });
            }
        }
        
        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('show');
        }
        
        // Fermer modal si clic en dehors
        document.getElementById('upgradeModal').addEventListener('click', (e) => {
            if (e.target.id === 'upgradeModal') {
                closeUpgradeModal();
            }
        });
        
        // ‚úÖ CORRECTION 1 : Variable pour bloquer l'analyse si modal ferm√©e
        let allowAnalysis = true;
        
        // Bouton analyser avec v√©rification de limite
        analyzeBtn.addEventListener('click', async () => {
            // ‚úÖ CORRECTION 1 : V√©rifier si l'analyse est autoris√©e
            if (!allowAnalysis) {
                allowAnalysis = true; // R√©initialiser pour la prochaine fois
                return;
            }
            
            // V√©rifier limite (sauf si Premium)
            if (!canAnalyze()) {
                showUpgradeModal();
                allowAnalysis = false; // ‚úÖ Bloquer l'analyse
                return;
            }
            
            if (!selectedFile) {
                showError('Veuillez s√©lectionner un CV');
                return;
            }
            
            // Incr√©menter compteur AVANT l'analyse (sauf si Premium)
            incrementAnalysisCount();
            
            uploadSection.style.display = 'none';
            loading.classList.add('show');
            
            try {
                const cvText = await extractTextFromPDF(selectedFile);
                const hasPhoto = document.getElementById('hasPhoto').checked;
                const analysis = await analyzeCVWithBackend(cvText, hasPhoto);
                displayResults(analysis);
                
                // ‚úÖ T√ÇCHE #2 : Lancer l'analyse ATS automatiquement apr√®s l'analyse CV
                await performATSAnalysis(cvText);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Erreur lors de l\'analyse : ' + error.message);
                uploadSection.style.display = 'block';
                loading.classList.remove('show');
                
                // D√©cr√©menter si erreur (sauf si Premium)
                if (!isPremiumUser()) {
                    const currentCount = getAnalysisCount();
                    if (currentCount > 0) {
                        localStorage.setItem('swisscv_analysis_count', (currentCount - 1).toString());
                        updateCounterDisplay();
                    }
                }
            }
        });
        
        // ‚úÖ CORRECTION 2 : D√©tecter retour depuis Stripe (success.html)
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Si param√®tre "premium=true" dans l'URL (ajout√© depuis success.html)
            if (urlParams.get('premium') === 'true') {
                localStorage.setItem('swisscv_premium', 'true');
                updateCounterDisplay();
                
                // Optionnel : Afficher message de bienvenue Premium
                alert('üéâ Bienvenue chez SwissCV Pro Premium ! Vous avez maintenant acc√®s aux analyses illimit√©es.');
            }
            
            // Initialiser compteur au chargement
            updateCounterDisplay();
            
            // V√©rifier au chargement si limite atteinte (pour users gratuits)
            if (!canAnalyze()) {
                analyzeBtn.textContent = 'üîí Limite atteinte - Passer √† Premium';
            }
        });
        
        // ==================== MODULE ANALYSE ATS (T√ÇCHE #2) ====================
        
        /**
         * Appel API pour l'analyse ATS
         * @param {string} cvText - Texte du CV
         * @returns {Promise<Object>} R√©sultat de l'analyse ATS
         */
        async function analyzeATSWithBackend(cvText) {
            const response = await fetch(`${API_ENDPOINT}/analyze-ats`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cv_text: cvText
                })
            });
            
            if (!response.ok) {
                throw new Error('Erreur lors de l\'analyse ATS');
            }
            
            return await response.json();
        }
        
        /**
         * Affiche les r√©sultats de l'analyse ATS
         * @param {Object} atsData - Donn√©es retourn√©es par l'API /analyze-ats
         */
        function displayATSResults(atsData) {
            // Masquer le chargement
            document.getElementById('atsLoadingState').style.display = 'none';
            
            // Afficher la section
            const atsSection = document.getElementById('atsSection');
            atsSection.style.display = 'block';
            
            // 1. Afficher le score
            const score = atsData.ats_score || 0;
            document.getElementById('atsScoreValue').textContent = score;
            
            // Animer la jauge
            setTimeout(() => {
                document.getElementById('atsGaugeFill').style.width = score + '%';
            }, 100);
            
            // Interpr√©tation du score
            const interpretation = document.getElementById('atsScoreInterpretation');
            if (score >= 80) {
                interpretation.innerHTML = 'üü¢ <strong>Excellent</strong> - Votre CV devrait passer les filtres ATS';
                interpretation.style.color = '#00AA00';
            } else if (score >= 60) {
                interpretation.innerHTML = 'üü† <strong>Correct</strong> - Quelques am√©liorations recommand√©es';
                interpretation.style.color = '#FF8800';
            } else {
                interpretation.innerHTML = 'üî¥ <strong>√Ä am√©liorer</strong> - Ajoutez les mots-cl√©s manquants';
                interpretation.style.color = '#D50000';
            }
            
            // 2. Afficher le secteur d√©tect√©
            document.getElementById('sectorName').textContent = atsData.sector_detected || 'Non identifi√©';
            
            // 3. Afficher les mots-cl√©s d√©tect√©s
            const detectedContainer = document.getElementById('detectedKeywordsContainer');
            if (atsData.keywords_detected && atsData.keywords_detected.length > 0) {
                const detectedBadges = atsData.keywords_detected
                    .map(kw => `<span class="importance-badge" style="background: #E6F7E6; color: #00AA00; border-color: #00AA00; margin: 4px;">${kw}</span>`)
                    .join('');
                detectedContainer.innerHTML = `<div style="display: flex; flex-wrap: wrap; gap: 8px;">${detectedBadges}</div>`;
            } else {
                detectedContainer.innerHTML = '<p style="color: #999; font-style: italic;">Aucun mot-cl√© sectoriel d√©tect√©</p>';
            }
            
            // 4. Afficher les mots-cl√©s manquants
            const missingBody = document.getElementById('missingKeywordsBody');
            missingBody.innerHTML = '';
            
            if (atsData.missing_keywords && atsData.missing_keywords.length > 0) {
                atsData.missing_keywords.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const importanceClass = {
                        'high': 'importance-high',
                        'medium': 'importance-medium',
                        'low': 'importance-low'
                    }[item.importance] || 'importance-low';
                    
                    const importanceLabel = {
                        'high': 'Haute',
                        'medium': 'Moyenne',
                        'low': 'Faible'
                    }[item.importance] || 'Faible';
                    
                    row.innerHTML = `
                        <td><span class="keyword-text">${item.keyword}</span></td>
                        <td><span class="importance-badge ${importanceClass}">${importanceLabel}</span></td>
                        <td><span class="keyword-missing">√Ä ajouter</span></td>
                    `;
                    
                    missingBody.appendChild(row);
                });
            } else {
                missingBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999; font-style: italic;">Tous les mots-cl√©s importants sont pr√©sents</td></tr>';
            }
            
            // 5. Afficher les conseils sectoriels
            const adviceList = document.getElementById('adviceList');
            adviceList.innerHTML = '';
            
            if (atsData.sector_advice && atsData.sector_advice.length > 0) {
                atsData.sector_advice.forEach(advice => {
                    const li = document.createElement('li');
                    li.textContent = advice;
                    adviceList.appendChild(li);
                });
            } else {
                adviceList.innerHTML = '<li style="border: none;">Aucun conseil sp√©cifique pour ce secteur</li>';
            }
            
            // Scroller jusqu'√† la section ATS
            setTimeout(() => {
                atsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }
        
        /**
         * Affiche l'√©tat de chargement ATS
         */
        function showATSLoading() {
            document.getElementById('atsSection').style.display = 'none';
            document.getElementById('atsLoadingState').style.display = 'flex';
        }
        
        /**
         * Masque tout (pour r√©initialisation)
         */
        function hideATSSection() {
            document.getElementById('atsSection').style.display = 'none';
            document.getElementById('atsLoadingState').style.display = 'none';
        }
        
        /**
         * Lance l'analyse ATS (appel√©e apr√®s l'analyse CV)
         * @param {string} cvText - Texte du CV
         */
        async function performATSAnalysis(cvText) {
            try {
                // Afficher le chargement
                showATSLoading();
                
                // Appeler l'API
                const atsData = await analyzeATSWithBackend(cvText);
                
                // Afficher les r√©sultats
                displayATSResults(atsData);
                
            } catch (error) {
                console.error('Erreur analyse ATS:', error);
                hideATSSection();
                // On ne bloque pas l'utilisateur, l'analyse CV reste visible
            }
        }
        
        // ==================== MODULE LETTRE DE MOTIVATION ====================
        
        // Fonction pour afficher le module lettre
        function showCoverLetterModule() {
            // V√©rifier si Premium
            if (!isPremiumUser()) {
                alert('‚≠ê Cette fonctionnalit√© est r√©serv√©e aux membres Premium.\n\nPassez √† Premium pour d√©bloquer la g√©n√©ration de lettres de motivation personnalis√©es !');
                window.location.href = 'pricing.html';
                return;
            }
            
            // Afficher le module
            document.getElementById('coverLetterSection').style.display = 'block';
            
            // Scroll vers le module
            document.getElementById('coverLetterSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        
        // G√©rer le changement de type de lettre
        document.querySelectorAll('input[name="letterType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const jobOfferGroup = document.getElementById('jobOfferGroup');
                if (e.target.value === 'spontaneous') {
                    jobOfferGroup.style.display = 'none';
                } else {
                    jobOfferGroup.style.display = 'block';
                }
            });
        });
        
        // Bouton fermer
        document.getElementById('closeCoverLetterBtn').addEventListener('click', () => {
            document.getElementById('coverLetterSection').style.display = 'none';
        });
        
        // G√©n√©rer la lettre
        document.getElementById('generateLetterBtn').addEventListener('click', async () => {
            const btn = document.getElementById('generateLetterBtn');
            const errorMsg = document.getElementById('coverLetterError');
            
            // R√©cup√©rer les valeurs
            const letterType = document.querySelector('input[name="letterType"]:checked').value;
            const companyName = document.getElementById('companyName').value.trim();
            const targetPosition = document.getElementById('targetPosition').value.trim();
            const industry = document.getElementById('industry').value;
            const jobOffer = document.getElementById('jobOffer').value.trim();
            const motivation = document.getElementById('motivation').value.trim();
            
            // Validation
            if (!companyName || !targetPosition) {
                errorMsg.textContent = '‚ö†Ô∏è Veuillez remplir les champs obligatoires (entreprise et poste)';
                errorMsg.classList.add('show');
                return;
            }
            
            // Masquer erreur
            errorMsg.classList.remove('show');
            
            // D√©sactiver bouton
            btn.disabled = true;
            btn.textContent = '‚è≥ G√©n√©ration en cours...';
            
            try {
                // Appeler l'API
                const response = await fetch(`${API_ENDPOINT}/generate-cover-letter`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        letterType,
                        companyName,
                        targetPosition,
                        industry,
                        jobOffer,
                        motivation,
                        cvText: selectedFile ? await extractTextFromPDF(selectedFile) : ''
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Erreur serveur');
                }
                
                const data = await response.json();
                
                // Afficher le r√©sultat
                displayCoverLetter(data);
                
                // Masquer le formulaire
                document.getElementById('coverLetterForm').style.display = 'none';
                document.getElementById('coverLetterResult').style.display = 'block';
                
            } catch (error) {
                console.error('Error:', error);
                errorMsg.textContent = '‚ùå Erreur lors de la g√©n√©ration. Veuillez r√©essayer.';
                errorMsg.classList.add('show');
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ú® G√©n√©rer la lettre de motivation';
            }
        });
        
        // Afficher la lettre g√©n√©r√©e
        function displayCoverLetter(data) {
            document.getElementById('letterSender').innerHTML = data.sender;
            document.getElementById('letterRecipient').innerHTML = data.recipient;
            document.getElementById('letterDate').innerHTML = data.date;
            document.getElementById('letterObject').innerHTML = `<strong>Objet :</strong> ${data.object}`;
            document.getElementById('letterBody').innerHTML = data.body;
            document.getElementById('letterSignature').innerHTML = data.signature;
        }
        
        // Nouvelle lettre
        document.getElementById('newLetterBtn').addEventListener('click', () => {
            // R√©initialiser le formulaire
            document.getElementById('companyName').value = '';
            document.getElementById('targetPosition').value = '';
            document.getElementById('industry').value = '';
            document.getElementById('jobOffer').value = '';
            document.getElementById('motivation').value = '';
            document.querySelector('input[name="letterType"][value="response"]').checked = true;
            
            // Afficher le formulaire
            document.getElementById('coverLetterForm').style.display = 'block';
            document.getElementById('coverLetterResult').style.display = 'none';
        });
        
        // Copier le texte
        document.getElementById('copyLetterBtn').addEventListener('click', () => {
            const letterText = 
                document.getElementById('letterSender').innerText + '\n\n' +
                document.getElementById('letterRecipient').innerText + '\n\n' +
                document.getElementById('letterDate').innerText + '\n\n' +
                document.getElementById('letterObject').innerText + '\n\n' +
                document.getElementById('letterBody').innerText + '\n\n' +
                document.getElementById('letterSignature').innerText;
            
            navigator.clipboard.writeText(letterText).then(() => {
                alert('‚úÖ Lettre copi√©e dans le presse-papier !');
            });
        });
        
        // Export PDF de la lettre
        document.getElementById('exportLetterPdfBtn').addEventListener('click', () => {
            // ‚úÖ Cr√©er une nouvelle fen√™tre avec SEULEMENT la lettre
            const printWindow = window.open('', '_blank');
            
            // R√©cup√©rer le contenu de la lettre
            const sender = document.getElementById('letterSender').innerHTML;
            const recipient = document.getElementById('letterRecipient').innerHTML;
            const date = document.getElementById('letterDate').innerHTML;
            const object = document.getElementById('letterObject').innerHTML;
            const body = document.getElementById('letterBody').innerHTML;
            const signature = document.getElementById('letterSignature').innerHTML;
            
            // Cr√©er le HTML de la fen√™tre d'impression
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <title>Lettre de Motivation - SwissCV Pro</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            font-family: 'Georgia', serif;
                            background: white;
                            color: #0D0D0D;
                            padding: 60px 80px;
                            line-height: 1.8;
                            max-width: 210mm;
                            margin: 0 auto;
                        }
                        .letter-header > div {
                            margin-bottom: 16px;
                        }
                        .letter-body {
                            margin: 32px 0;
                            white-space: pre-wrap;
                        }
                        .letter-signature {
                            margin-top: 40px;
                        }
                        @media print {
                            body {
                                padding: 40px 60px;
                            }
                            @page {
                                margin: 2cm;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="letter-header">
                        <div>${sender}</div>
                        <div>${recipient}</div>
                        <div>${date}</div>
                        <div>${object}</div>
                    </div>
                    <div class="letter-body">${body}</div>
                    <div class="letter-signature">${signature}</div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            // Attendre un court instant que le contenu soit rendu puis imprimer
            setTimeout(() => {
                printWindow.print();
            }, 250);
        });
        
        // Ajouter bouton "G√©n√©rer lettre" dans les actions (apr√®s analyse CV)
        function addCoverLetterButton() {
            if (isPremiumUser()) {
                const actionsDiv = document.querySelector('.actions');
                
                // V√©rifier si le bouton existe d√©j√†
                if (!document.getElementById('openCoverLetterBtn')) {
                    const coverLetterBtn = document.createElement('button');
                    coverLetterBtn.id = 'openCoverLetterBtn';
                    coverLetterBtn.className = 'btn';
                    coverLetterBtn.innerHTML = '‚úâÔ∏è G√©n√©rer lettre de motivation';
                    coverLetterBtn.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                    coverLetterBtn.style.color = 'var(--swiss-black)';
                    
                    coverLetterBtn.addEventListener('click', showCoverLetterModule);
                    
                    actionsDiv.appendChild(coverLetterBtn);
                }
            }
        }
    </script>
</body>
</html>
